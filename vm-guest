#!/bin/bash

# List of ESXi hosts
hosts=(
    "host1.example.com"
    "host2.example.com"
    # Add more hosts as needed
)

# Email settings
recipient="your_email@example.com"
subject="CRC Errors Report"
body=""

# Loop through each ESXi host
for host in "${hosts[@]}"; do
    # Add a separator for each host in the email body
    body+="CRC errors for host $host:\n"
    
    # Run esxcli command to list NICs
    nics=$(ssh "$host" 'esxcli network nic list | awk "NR>1 {print \$1}"')
    
    # Loop through each NIC and get its statistics
    for nic in $nics; do
        nic_stats=$(ssh "$host" "esxcli network nic stats get -n $nic | grep 'CRC Errors'")
        
        if [[ $nic_stats == *"CRC Errors"* ]]; then
            crc_errors=$(echo $nic_stats | awk '{print $3}')
            
            # Check if CRC errors are greater than 0
            if [[ $crc_errors -gt 0 ]]; then
                body+="NIC: $nic, CRC Errors: $crc_errors\n"
            fi
        fi
    done
    
    body+="\n"
done

# Send email if there are any CRC errors
if [[ -n "$body" ]]; then
    echo -e "$body" | mail -s "$subject" "$recipient"
fi
